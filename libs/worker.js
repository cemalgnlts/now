(()=>{var t=require("./tinyemu/x86emu-wasm.js");self.onmessage=async function({data:n}){const{cmd:r,msg:o}=n;switch(r){case"boot":p();break;case"stdin":h(o);break;case"listen-stdout":case"listen-data":b(r.split("-")[1]);break}};let a=!1,l=!1,u=null,c,f;const s={cfg:`${location.origin}/tinyemu/alpine-x86.cfg`,memSize:192,cmdline:"",width:0,height:0,netUrl:"wss://relay.widgetry.org/",driveUrl:""};t.Module.preRun=w;t.Module.termSize=[80,30];t.events.addEventListener("updateDownloading",g);t.events.addEventListener("stdout",m);function p(){if(a){postMessage({cmd:"warn",msg:"Shell is already initialized."});return}(0,t.installWASM)()}function b(e){t.events.addEventListener(e,n=>{l&&postMessage({type:e,cmd:"event",msg:n.detail})})}function g(e){const n=e.detail;self.postMessage(n?"---> Downloading":"Downloaded <---")}function m(e){const n=e.detail;a===!1&&n.startsWith("localhost:")?y():a&&l===!1&&n.startsWith("localhost:")&&(k(),postMessage({type:"stdout",cmd:"event",msg:e.detail}),postMessage({type:"data",cmd:"event",msg:e.detail}))}function y(){a=!0,h(`node --version
`)}function k(){l=!0,t.events.removeEventListener("updateDownloading",g),t.events.removeEventListener("stdout",m),postMessage({cmd:"ready"})}function h(e){for(const n of e)u(n.charCodeAt())}function w(){u=t.Module.cwrap("console_queue_char",null,["number"]),f=t.Module.cwrap("net_write_packet",null,["number","number"]),c=t.Module.cwrap("net_set_carrier",null,["number"]),s.netUrl!==""&&(t.Module.net_state=new i(s.netUrl)),(0,t.ccall)("vm_start",null,["string","number","string","string","number","number","number","string"],[s.cfg,s.memSize,s.cmdline,null,s.width,s.height,t.Module.net_state!=null|0,s.driveUrl])}function i(e){try{this.socket=new WebSocket(e)}catch{this.socket=null,console.log("Could not open websocket url="+e);return}this.socket.binaryType="arraybuffer",this.socket.onmessage=this.messageHandler.bind(this),this.socket.onclose=this.closeHandler.bind(this),this.socket.onopen=this.openHandler.bind(this),this.socket.onerror=this.errorHandler.bind(this)}i.prototype.openHandler=function(e){c(1)};i.prototype.closeHandler=function(e){c(0)};i.prototype.errorHandler=function(e){console.log("Websocket error="+e)};i.prototype.messageHandler=function(e){var n,r,o,d;if(e.data instanceof ArrayBuffer)r=e.data.byteLength,d=new Uint8Array(e.data),o=t.Module._malloc(r),t.Module.HEAPU8.set(d,o),f(o,r),t.Module._free(o);else if(n=e.data.toString(),n.substring(0,5)=="ping:")try{this.socket.send("pong:"+n.substring(5))}catch{}};i.prototype.recv_packet=function(e){if(this.socket)try{this.socket.send(e)}catch{}};})();
